!function(e){function t(t){for(var r,c,u=t[0],i=t[1],s=t[2],f=0,p=[];f<u.length;f++)c=u[f],o[c]&&p.push(o[c][0]),o[c]=0;for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r]);for(l&&l(t);p.length;)p.shift()();return a.push.apply(a,s||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,u=1;u<n.length;u++){var i=n[u];0!==o[i]&&(r=!1)}r&&(a.splice(t--,1),e=c(c.s=n[0]))}return e}var r={},o={1:0},a=[];function c(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,c),n.l=!0,n.exports}c.m=e,c.c=r,c.d=function(e,t,n){c.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},c.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.t=function(e,t){if(1&t&&(e=c(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(c.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)c.d(n,r,function(t){return e[t]}.bind(null,r));return n},c.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return c.d(t,"a",t),t},c.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},c.p="";var u=window.webpackJsonp=window.webpackJsonp||[],i=u.push.bind(u);u.push=t,u=u.slice();for(var s=0;s<u.length;s++)t(u[s]);var l=i;a.push([311,0]),n()}({138:function(e,t,n){e.exports=n.p+"manifest.json"},151:function(e,t){},311:function(e,t,n){"use strict";n.r(t);n(86);var r=n(16),o=n.n(r),a=n(84),c=n.n(a),u=n(68),i=n.n(u),s=n(14),l=n(133),f=n.n(l),p=n(69),h=n.n(p),d=n(24),v={chains:[{chainId:"testnet.aergo.io",nodeUrl:"http://testnet.aergo.io:7845"},{chainId:"main.aergo.io",nodeUrl:"http://mainnet-node1.aergo.io:7845"},{chainId:"sqltestnet.aergo.io",nodeUrl:"http://sqltestnet.aergo.io:7845"},{chainId:"dev.chain",nodeUrl:"http://127.0.0.1:7845"}]},m=n(17),g=n(5);function y(e,t,n,r,o,a,c){try{var u=e[a](c),i=u.value}catch(e){return void n(e)}u.done?t(i):Promise.resolve(i).then(r,o)}function k(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function c(e){y(a,r,o,c,u,"next",e)}function u(e){y(a,r,o,c,u,"throw",e)}c(void 0)})}}function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var b=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&w(e.prototype,t),n&&w(e,n)}(e,[{key:"fetchAccountTransactionsAfter",value:function(e){return function(e){return function(){var t=k(regeneratorRuntime.mark(function t(n){var r,o,a,c,u,i,s,l,f,p,h;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.account,o=n.blockno,a=n.limit,"testnet.aergo.io"===(c=r.data.spec.chainId)){t.next=4;break}return t.abrupt("return",e({account:r,blockno:o,limit:a}));case 4:return u=new g.Address(r.data.spec.address),console.log("[track account] Fetching txs for ".concat(u," on ").concat(c," since ").concat(o,"...")),i=encodeURIComponent("(from:".concat(u," OR to:").concat(u,") AND blockno:>").concat(o)),s=1e3,l=0,f="".concat("https://api.aergoscan.io/testnet","/transactions?q=").concat(i,"&sort=blockno:desc&size=").concat(s,"&from=").concat(l),t.next=13,fetch(f);case 13:return p=t.sent,t.next=16,p.json();case 16:return h=t.sent,console.log("[track account] Got ".concat(h.hits.length," (of ").concat(h.total,") txs for ").concat(u," since ").concat(o,".")),t.abrupt("return",h.hits.map(function(e){return new d.Transaction(e.hash,{chainId:c,from:e.meta.from,to:e.meta.to,hash:e.hash,ts:e.meta.ts,blockhash:"",blockno:e.meta.blockno,amount:e.meta.amount,type:e.meta.type,status:d.Transaction.Status.Confirmed})}));case 19:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}}},{key:"fetchAccountTransactions",value:function(e){var t=this;return function(){return function(){var n=k(regeneratorRuntime.mark(function n(r){var o,a,c;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return o=e.accountManager.getCompleteAccountSpec(r.data.spec),n.next=3,e.getClient(o.chainId).blockchain();case 3:return a=n.sent,c=a.bestHeight,n.abrupt("return",t.fetchAccountTransactionsBefore(e)(k(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",[]);case 1:case"end":return e.stop()}},e,this)})))({account:r,blockno:c}));case 6:case"end":return n.stop()}},n,this)}));return function(e){return n.apply(this,arguments)}}()}}}]),e}(),x=n(12);function R(e){return(R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function A(e,t){return!t||"object"!==R(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _(e){return(_=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function T(e,t){return(T=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=A(this,_(t).call(this)))._idleTimeout=null,e.set("initial"),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&T(e,t)}(t,s["EventEmitter"]),function(e,t,n){t&&O(e.prototype,t),n&&O(e,n)}(t,[{key:"set",value:function(e){var t=this;"inactive"!=e&&this._idleTimeout&&clearTimeout(this._idleTimeout),this.state!=e&&"inactive"==e&&(this._idleTimeout&&clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(function(){t.set("idle")},6e4)),this.state!=e&&console.log("[state] ".concat(this.state," -> ").concat(e)),this.state=e,this.emit("change",e),this.emit(e)}}]),t}();n(239),n(23),n(3);function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function P(e,t,n,r,o,a,c){try{var u=e[a](c),i=u.value}catch(e){return void n(e)}u.done?t(i):Promise.resolve(i).then(r,o)}function M(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function c(e){P(a,r,o,c,u,"next",e)}function u(e){P(a,r,o,c,u,"throw",e)}c(void 0)})}}function I(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function U(e,t){return!t||"object"!==j(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function C(e){return(C=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function E(e,t){return(E=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var K=function(e){function t(){var e;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=U(this,C(t).call(this))).id=o.a.runtime.id,e.uiState={popupOpen:!1},e.state=new S,e._lockTimeout=null,e.wallet=new d.Wallet({appName:"aergo-browser-wallet",instanceId:e.id}),e.wallet.use(b),e.wallet.useStorage(m.a).then(function(){e.firstLoad()});var n=!0,r=!1,a=void 0;try{for(var c,u=v.chains[Symbol.iterator]();!(n=(c=u.next()).done);n=!0){var i=c.value;e.wallet.useChain(i)}}catch(e){r=!0,a=e}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return e.wallet.keyManager.on("lock",function(){e.emit("update",{unlocked:!1}),console.log("[lock] locked")}),e.wallet.keyManager.on("unlock",function(){e.emit("update",{unlocked:!0}),console.log("[lock] unlocked")}),e.state.on("idle",function(){console.log("[state] idle, pausing trackers"),e.wallet.accountManager.pause(),e.wallet.transactionManager.pause()}),e.state.on("active",function(){console.log("[state] active, resuming trackers"),e.wallet.accountManager.resume(),e.wallet.transactionManager.resume()}),e.lock(),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&E(e,t)}(t,s["EventEmitter"]),function(e,t,n){t&&I(e.prototype,t),n&&I(e,n)}(t,[{key:"firstLoad",value:function(){var e=M(regeneratorRuntime.mark(function e(){var t,n,r,o,a,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wallet.accountManager.getAccounts();case 2:for(t=e.sent,n=!0,r=!1,o=void 0,e.prev=6,a=t[Symbol.iterator]();!(n=(c=a.next()).done);n=!0)u=c.value,this.trackAccount(u);e.next=14;break;case 10:e.prev=10,e.t0=e.catch(6),r=!0,o=e.t0;case 14:e.prev=14,e.prev=15,n||null==a.return||a.return();case 17:if(e.prev=17,!r){e.next=20;break}throw o;case 20:return e.finish(17);case 21:return e.finish(14);case 22:case"end":return e.stop()}},e,this,[[6,10,14,22],[15,,17,21]])}));return function(){return e.apply(this,arguments)}}()},{key:"lock",value:function(){this.wallet.lock()}},{key:"unlock",value:function(){var e=M(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wallet.unlock(t);case 2:this.keepUnlocked();case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setupAndUnlock",value:function(){var e=M(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.wallet.setupAndUnlock(t);case 2:this.keepUnlocked();case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"keepUnlocked",value:function(){var e=this;this._lockTimeout&&clearTimeout(this._lockTimeout),this._lockTimeout=setTimeout(function(){console.log("[lock] auto-locking..."),e.lock()},6e4)}},{key:"isUiOpen",value:function(){return this.uiState.popupOpen}},{key:"trackAccount",value:function(e,t){var n=this,r=this.wallet.accountManager.trackAccount(e);this.wallet.transactionManager.trackAccount(e),r.then(function(e){e.removeAllListeners("update"),e.on("update",function(e){console.log("got new state",e),n.emit("update",{accounts:[e]}),t&&(t(e),t=!1)})})}},{key:"setupCommunication",value:function(e){var t=this,n=h()({unlock:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.password,e.prev=1,e.next=4,t.unlock(o);case 4:e.next=11;break;case 6:return e.prev=6,e.t0=e.catch(1),console.error(e.t0),r({error:""+e.t0}),e.abrupt("return");case 11:r({});case 12:case"end":return e.stop()}},e,this,[[1,6]])}));return function(t,n){return e.apply(this,arguments)}}(),lock:function(){var e=M(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.lock(),n({});case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),setup:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.password,e.next=3,t.setupAndUnlock(o);case 3:r({});case 4:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),isUnlocked:function(){var e=M(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n(t.wallet.unlocked);case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),reset:function(){var e=M(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,m.a.open();case 2:return e.next=4,m.a.getIndex("accounts").clear();case 4:return e.next=6,m.a.getIndex("transactions").clear();case 6:return e.next=8,m.a.getIndex("settings").clear();case 8:return e.next=10,m.a.getIndex("keys").clear();case 10:t();case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),getBlockchainStatus:function(){var e=M(regeneratorRuntime.mark(function e(n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.wallet.getClient().blockchain();case 2:r=e.sent,n({blockHeight:r.bestHeight,chainId:t.wallet.defaultChainId});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),getAccounts:function(){var e=M(regeneratorRuntime.mark(function e(n){var r,o,a,c,u,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.keepUnlocked(),e.next=3,t.wallet.accountManager.getAccounts();case 3:for(r=e.sent,o=!0,a=!1,c=void 0,e.prev=7,u=r[Symbol.iterator]();!(o=(i=u.next()).done);o=!0)s=i.value,t.trackAccount(s);e.next=15;break;case 11:e.prev=11,e.t0=e.catch(7),a=!0,c=e.t0;case 15:e.prev=15,e.prev=16,o||null==u.return||u.return();case 18:if(e.prev=18,!a){e.next=21;break}throw c;case 21:return e.finish(18);case 22:return e.finish(15);case 23:n(r);case 24:case"end":return e.stop()}},e,this,[[7,11,15,23],[16,,18,22]])}));return function(t){return e.apply(this,arguments)}}(),createAccount:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.chainId,t.keepUnlocked(),e.next=4,t.wallet.accountManager.createAccount(o);case 4:a=e.sent,t.trackAccount(a),r(a.data.spec);case 7:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),importAccount:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o,a,c,u,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.privateKey,a=n.chainId,t.keepUnlocked(),c=Object(x.identifyFromPrivateKey)(o),u=c.address,e.prev=4,e.next=7,t.wallet.accountManager.addAccount({address:u,chainId:a});case 7:return i=e.sent,console.log("importAccount",i,o),e.next=11,t.wallet.keyManager.importKey({account:i,privateKey:o});case 11:t.trackAccount(i),r(i.data.spec),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(4),console.error(e.t0),r({error:"Could not import account. "+e.t0});case 19:case"end":return e.stop()}},e,this,[[4,15]])}));return function(t,n){return e.apply(this,arguments)}}(),exportAccount:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o,a,c,u,i,s,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.address,a=n.chainId,c=n.password,t.keepUnlocked(),e.next=4,t.wallet.accountManager.getOrAddAccount({address:o,chainId:a});case 4:return u=e.sent,e.next=7,t.wallet.keyManager.getKey(u);case 7:return i=e.sent,console.log(u,i),s=i.data.privateKey,e.next=12,Object(x.encryptPrivateKey)(s,c);case 12:l=e.sent,r({privateKey:Object(x.encodePrivateKey)(l)});case 14:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),sendTransaction:function(){var e=M(regeneratorRuntime.mark(function e(n,r,o){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.keepUnlocked(),e.prev=1,e.next=4,t.wallet.sendTransaction({address:n.from,chainId:r},n);case 4:a=e.sent,console.log(a,a.transaction.txBody),o({tx:a.transaction.txBody}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),console.error(e.t0),o({error:e.t0.message||""+e.t0});case 13:case"end":return e.stop()}},e,this,[[1,9]])}));return function(t,n,r){return e.apply(this,arguments)}}(),getAccountTx:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("getAccountTx",n),n.address){e.next=3;break}return e.abrupt("return",r({}));case 3:return e.next=5,t.wallet.transactionManager.getAccountTransactions(n);case 5:(o=e.sent).sort(function(e,t){return e.data.ts<t.data.ts?1:e.data.ts==t.data.ts?0:-1}),r(o);case 8:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),syncAccountState:function(){var e=M(regeneratorRuntime.mark(function e(n,r){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.address){e.next=2;break}return e.abrupt("return",r({}));case 2:return e.next=4,t.wallet.accountManager.getOrAddAccount(n);case 4:o=e.sent,t.trackAccount(o,r);case 6:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()});f()(e,n,e,function(e){e&&log.error(e)}),n.on("remote",function(e){var n=e.sendUpdate.bind(e);t.on("update",n)}),this.state.on("change",function(e){t.emit("update",{state:e})})}}]),t}();function B(e,t,n,r,o,a,c){try{var u=e[a](c),i=u.value}catch(e){return void n(e)}u.done?t(i):Promise.resolve(i).then(r,o)}function L(){return(L=function(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function c(e){B(a,r,o,c,u,"next",e)}function u(e){B(a,r,o,c,u,"throw",e)}c(void 0)})}}(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=function(e){var n=e.name;console.log("Establishing connection with",n),t.state.set("active");var r=new i.a(e);t.setupCommunication(r),t.uiState.popupOpen=!0,c()(r,function(){t.uiState.popupOpen=!1,console.log("Closed connection with",n),t.state.set("inactive")})},t=new K,o.a.runtime.onConnect.addListener(n);case 3:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}n(138),console.log("AERGO Wallet Background Script"),console.log("Extension ID",o.a.runtime.id),function(){L.apply(this,arguments)}(),chrome.contextMenus.removeAll(),chrome.contextMenus.create({title:"Open full page",contexts:["browser_action"],onclick:function(){o.a.tabs.create({url:"tab.html"})}}),o.a.tabs.create({url:"tab.html"})}});
//# sourceMappingURL=background.js.map